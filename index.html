<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AR Discount â€” Checking...</title>
  <style>
    body{
      font-family:Poppins,Arial,sans-serif;
      margin:0;display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      height:100vh;background:#fff;color:#222;text-align:center
    }
    .loader{
      width:44px;height:44px;border-radius:50%;
      border:5px solid #eee;border-top:5px solid #0b8d6d;
      animation:spin 1s linear infinite;margin-bottom:20px
    }
    @keyframes spin{100%{transform:rotate(360deg)}}
    h1{font-size:18px;margin:0 0 8px}
    p{margin:0;color:#555;max-width:260px}
  </style>
</head>
<body>
  <div class="loader"></div>
  <h1>Checking your AR reward...</h1>
  <p id="msg">Please wait â€” connecting to system</p>

<script>
(async function(){
  const BACKEND = "https://script.google.com/macros/s/AKfycbxIOMPWVC_nIrmUr0Df1zI8Yn0c7zhS8ey5iyQYkSS9HOJlCqnuvOelR9oBgYTSVcVm/exec";
  const AR_PAGE = "https://rudrasinh03.github.io/ar-card/"; // your AR page link

  const params = new URLSearchParams(window.location.search);
  const card = params.get('card') || params.get('id');
  const msgEl = document.getElementById('msg');

  if(!card){
    msgEl.innerText = "âŒ Invalid card â€” missing card ID.";
    return;
  }

  try{
    const controller = new AbortController();
    const timeout = setTimeout(()=>controller.abort(), 10000); // 10s timeout

    const resp = await fetch(`${BACKEND}?card=${encodeURIComponent(card)}&mode=update`, { signal: controller.signal });
    clearTimeout(timeout);
    const json = await resp.json();

    console.log("Backend:", json);

    if(json.status !== "ok"){
      msgEl.innerText = "âš ï¸ " + json.message;
      return;
    }

    msgEl.innerText = "âœ… Verified! Redirecting to your AR experience...";
    const discount = encodeURIComponent(json.discount_assigned || "");
    const isFirst = json.isFirstScan ? "true" : "false";

    setTimeout(()=>{
      window.location.href = `${AR_PAGE}?id=${encodeURIComponent(card)}&isFirst=${isFirst}&discount=${discount}`;
    }, 800);

  }catch(err){
    console.error(err);
    msgEl.innerText = "ðŸš« Connection failed. Please try again.";
  }
})();
</script>
</body>
</html>
